<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infographic: Vòng Quay Hàng Hóa - Nghệ Năng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lightest gray background */
            line-height: 1.6;
            color: #334155; /* Darker text for better readability */
        }
        .header-gradient {
            background: linear-gradient(to right, #1a56db, #3b82f6); /* Stronger blue gradient */
        }
        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1a56db;
            position: relative;
            padding-bottom: 0.75rem;
            margin-bottom: 2.5rem;
            text-align: center;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 100px;
            height: 5px;
            background-color: #3b82f6; /* Accent line */
            border-radius: 3px;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%; /* Ensure cards in a grid have equal height */
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .formula-box {
            background-color: #e0f2fe; /* Light blue background for formulas */
            border-left: 5px solid #3b82f6;
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e40af; /* Darker blue text */
            text-align: center; /* Center the text within the box */
        }
        .formula-box .formula-text {
            display: block;
            margin: 0.75rem 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .example-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .example-step-number {
            background-color: #3b82f6;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 600px; /* Ensure table doesn't get too narrow on small screens */
        }
        .data-table th, .data-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background-color: #f0f4f8;
            font-weight: 700;
            color: #475569;
        }
        .data-table tbody tr {
            background-color: #ffffff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .data-table tbody tr:hover {
            background-color: #e0f2fe; /* Light blue hover for table rows */
            box-shadow: inset 0 0 0 2px #3b82f6; /* Subtle border on hover */
        }
        .pro-con-card {
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .pro-con-card.pro {
            background-color: #ecfdf5; /* Light green */
            border-left: 5px solid #10b981; /* Green border */
        }
        .pro-con-card.con {
            background-color: #fef2f2; /* Light red */
            border-left: 5-px solid #ef4444; /* Red border */
        }
        .pro-con-card h4 {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .pro-con-card ul {
            list-style: disc;
            padding-left: 1.25rem;
        }
        .pro-con-card li {
            margin-bottom: 0.5rem;
        }
        .icon-text-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .icon-text-item .icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
            line-height: 1;
        }
        .icon-text-item p {
            font-size: 0.95rem;
        }
        /* Custom styles for the calculator section */
        .calculator-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 900px; /* Increased max-width for a larger frame */
        }
        .calculator-input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .calculator-input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #475569;
            text-align: left; /* Align label text to the left */
        }
        .calculator-input-group input {
            width: 100%;
            height: 48px; /* Fixed height for uniform inputs */
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.3s ease;
            font-size: 1rem;
            text-align: center; /* Center the input text */
        }
        .calculator-input-group input:focus {
            border-color: #3b82f6;
        }
        .calculator-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
            background-color: #3b82f6;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .calculator-button:hover {
            background-color: #1a56db;
            transform: translateY(-2px);
        }
        .calculator-button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        .history-button {
            background-color: #64748b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .history-button:hover {
            background-color: #475569;
        }
        #result-display {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            display: none; /* Hide by default */
        }
        #result-display h3 {
            font-weight: 700;
            font-size: 1.5rem;
            color: #4338ca;
            margin-bottom: 1rem;
        }
        #result-display p {
            margin-bottom: 0.5rem;
            color: #4f46e5;
        }
        #analysis-text {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #c7d2fe;
            color: #3730a3;
        }
        #analysis-text ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #analysis-text li {
            margin-bottom: 5px;
        }
        #loading-indicator {
            display: none;
            text-align: center;
            font-style: italic;
            color: #64748b;
        }
        #save-button {
            display: none; /* Hide until a result is generated */
            background-color: #22c55e;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #save-button:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }
        #save-status {
            display: none;
            margin-left: 1rem;
            font-style: italic;
            color: #16a34a;
        }
        #history-section {
            display: none;
            margin-top: 2rem;
        }
        .history-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }
        .history-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .history-item details > summary {
            list-style: none; /* Hide default arrow */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-weight: 600;
            color: #1a56db;
        }
        .history-item details > summary::-webkit-details-marker {
            display: none; /* For Chrome/Safari */
        }
        .history-item details > summary::before {
            content: '▶';
            margin-right: 0.75rem;
            transition: transform 0.2s ease;
            color: #3b82f6;
        }
        .history-item details[open] > summary::before {
            content: '▼';
            transform: rotate(90deg);
        }
        .history-details-content {
            padding-left: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #475569;
        }
        .comparison-analysis {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background-color: #d1fae5; /* Light green */
            border: 1px solid #34d399; /* Green border */
            color: #065f46;
        }
        .comparison-analysis.decline {
            background-color: #fee2e2; /* Light red */
            border: 1px solid #f87171; /* Red border */
            color: #991b1b;
        }
        .comparison-analysis h4 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .comparison-analysis p {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

    <header class="header-gradient text-white py-8 shadow-lg">
        <div class="container mx-auto px-6 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2">Vòng Quay Hàng Hóa</h1>
            <p class="text-xl opacity-90">Chỉ số then chốt đánh giá hiệu quả quản lý tồn kho</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">

        <section id="introduction" class="mb-12 text-center max-w-4xl mx-auto">
            <p class="text-lg text-gray-700 leading-relaxed">
                <strong class="text-[#1a56db]">Vòng Quay Hàng Hóa (Inventory Turnover)</strong> là một chỉ số tài chính quan trọng, đo lường số lần một công ty bán và thay thế hàng tồn kho của mình trong một khoảng thời gian nhất định (thường là một năm). Chỉ số này phản ánh hiệu quả quản lý hàng tồn kho của doanh nghiệp.
            </p>
        </section>
        
        <section id="formulas" class="mb-16">
            <h2 class="section-title">I. Công Thức Tính Vòng Quay Hàng Hóa</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h3 class="text-xl font-bold text-[#1a56db] mb-4">1. Sử dụng Giá vốn hàng bán (COGS)</h3>
                    <div class="formula-box">
                        <span class="formula-text">Vòng Quay Hàng Hóa = Giá vốn hàng bán / Hàng tồn kho bình quân</span>
                    </div>
                    <p class="text-sm text-gray-600">
                        Giá vốn hàng bán (COGS) là tổng chi phí trực tiếp để sản xuất hàng hóa hoặc dịch vụ đã bán. Đây là chỉ số được ưu tiên hơn vì nó phản ánh chi phí thực tế của hàng hóa đã bán.
                    </p>
                </div>
                <div class="card">
                    <h3 class="text-xl font-bold text-[#1a56db] mb-4">2. Sử dụng Doanh thu thuần (Net Sales)</h3>
                    <div class="formula-box">
                        <span class="formula-text">Vòng Quay Hàng Hóa = Doanh thu thuần / Hàng tồn kho bình quân</span>
                    </div>
                    <p class="text-sm text-gray-600">
                        Doanh thu thuần (Net Sales) là tổng doanh thu từ việc bán hàng sau khi trừ đi các khoản giảm trừ doanh thu.
                    </p>
                </div>
            </div>
            <div class="card mt-8">
                <h3 class="text-xl font-bold text-[#1a56db] mb-4">Cách tính Hàng tồn kho bình quân</h3>
                <div class="formula-box">
                    <span class="formula-text">Hàng tồn kho bình quân = (Hàng tồn kho đầu kỳ + Hàng tồn kho cuối kỳ) / 2</span>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p><strong>Hàng tồn kho đầu kỳ:</strong> Là giá trị hàng hóa tồn kho tại thời điểm bắt đầu một kỳ kế toán (ví dụ: ngày 1 tháng 1 của năm tài chính).</p>
                    <p><strong>Hàng tồn kho cuối kỳ:</strong> Là giá trị hàng hóa tồn kho tại thời điểm kết thúc một kỳ kế toán (ví dụ: ngày 31 tháng 12 của năm tài chính).</p>
                </div>
            </div>
        </section>

        <section id="example" class="mb-16">
            <h2 class="section-title">Ví dụ minh họa: Công ty TNHH Công nghiệp Nghệ Năng</h2>
            <div class="card">
                <p class="mb-4 text-gray-700">Giả sử Công ty TNHH Công nghiệp Nghệ Năng có các số liệu sau trong năm 2024:</p>
                <ul class="list-disc list-inside text-gray-700 mb-6">
                    <li>Giá vốn hàng bán (COGS): <strong>15.000.000.000 VNĐ</strong> (tổng chi phí sản xuất trực tiếp của các sản phẩm đã bán ra trong năm)</li>
                    <li>Hàng tồn kho đầu kỳ: <strong>2.500.000.000 VNĐ</strong> (giá trị hàng hóa còn lại trong kho vào ngày 01/01/2024)</li>
                    <li>Hàng tồn kho cuối kỳ: <strong>3.500.000.000 VNĐ</strong> (giá trị hàng hóa còn lại trong kho vào ngày 31/12/2024)</li>
                </ul>

                <div class="example-step">
                    <span class="example-step-number">1</span>
                    <div>
                        <h4 class="font-semibold text-lg text-[#1a56db]">Tính Hàng tồn kho bình quân</h4>
                        <div class="formula-box">
                            <span class="formula-text">Hàng tồn kho bình quân = (2.5 tỷ + 3.5 tỷ) / 2 = 3.0 tỷ VNĐ</span>
                        </div>
                    </div>
                </div>

                <div class="example-step">
                    <span class="example-step-number">2</span>
                    <div>
                        <h4 class="font-semibold text-lg text-[#1a56db]">Tính Vòng Quay Hàng Hóa</h4>
                        <div class="formula-box">
                            <span class="formula-text">Vòng Quay Hàng Hóa = 15 tỷ / 3 tỷ = 5 lần</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-800">
                    <p class="font-semibold"><strong>Kết luận:</strong> Trong năm 2024, Nghệ Năng đã bán và thay thế toàn bộ lượng hàng tồn kho của mình 5 lần. Một vòng quay 5 lần cho thấy Nghệ Năng đang quản lý hàng tồn kho khá hiệu quả, có khả năng chuyển đổi hàng tồn kho thành doanh thu trong khoảng thời gian tương đối ngắn. Tuy nhiên, để đánh giá chính xác hơn, cần so sánh chỉ số này với các doanh nghiệp cùng ngành hoặc với dữ liệu lịch sử của chính Nghệ Năng.</p>
                </div>
            </div>
        </section>

        <section id="meaning" class="mb-16">
            <h2 class="section-title">II. Ý Nghĩa của Vòng Quay Hàng Hóa</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card text-center">
                    <div class="text-4xl text-[#3b82f6] mb-3">📈</div>
                    <h3 class="font-bold text-lg mb-2">Hiệu quả quản lý tồn kho</h3>
                    <p class="text-sm text-gray-600">Phản ánh mức độ hiệu quả trong việc quản lý hàng tồn kho.</p>
                </div>
                <div class="card text-center">
                    <div class="text-4xl text-[#3b82f6] mb-3">💸</div>
                    <h3 class="font-bold text-lg mb-2">Thanh khoản</h3>
                    <p class="text-sm text-gray-600">Khả năng chuyển đổi hàng tồn kho thành tiền mặt nhanh chóng.</p>
                </div>
                <div class="card text-center">
                    <div class="text-4xl text-[#3b82f6] mb-3">⚠️</div>
                    <h3 class="font-bold text-lg mb-2">Rủi ro lỗi thời/hư hỏng</h3>
                    <p class="text-sm text-gray-600">Vòng quay thấp báo hiệu rủi ro hàng tồn kho bị lỗi thời.</p>
                </div>
                <div class="card text-center">
                    <div class="text-4xl text-[#3b82f6] mb-3">🚀</div>
                    <h3 class="font-bold text-lg mb-2">Hiệu suất bán hàng</h3>
                    <p class="text-sm text-gray-600">Gián tiếp phản ánh tốc độ bán hàng của doanh nghiệp.</p>
                </div>
            </div>

            <div class="mt-12">
                <h3 class="text-2xl font-bold text-[#1a56db] text-center mb-6">Ý nghĩa đối với Công ty TNHH Công nghiệp Nghệ Năng</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                        <h4 class="font-bold text-xl text-[#3b82f6] mb-3">1. Đánh giá hiệu quả hoạt động từng kênh</h4>
                        <ul class="list-disc list-inside text-gray-700 text-sm">
                            <li><strong>Showroom & GT:</strong> Vòng quay cao = sản phẩm bán chạy, chiến lược hiệu quả. Vòng quay thấp = cần điều chỉnh giá, marketing.</li>
                            <li><strong>OEM & Dự án:</strong> Theo dõi vòng quay nguyên vật liệu/bán thành phẩm để tránh ứ đọng linh kiện chuyên biệt.</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-xl text-[#3b82f6] mb-3">2. Tối ưu hóa chính sách giá và chiết khấu</h4>
                        <ul class="list-disc list-inside text-gray-700 text-sm">
                            <li><strong>Vòng quay cao:</strong> Tự tin áp dụng chiết khấu linh hoạt để đẩy mạnh doanh số.</li>
                            <li><strong>Vòng quay thấp:</strong> Cần xem xét lại chiến lược giá, khuyến mãi sâu hơn hoặc điều chỉnh danh mục sản phẩm.</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-xl text-[#3b82f6] mb-3">3. Quản lý dòng tiền và vốn lưu động</h4>
                        <ul class="list-disc list-inside text-gray-700 text-sm">
                            <li><strong>Vòng quay nhanh:</strong> Thu hồi vốn nhanh, giảm nhu cầu vốn lưu động, cải thiện dòng tiền.</li>
                            <li><strong>Vòng quay chậm:</strong> "Chôn vốn" vào tồn kho, ảnh hưởng đến dòng tiền và khả năng đầu tư.</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4 class="font-bold text-xl text-[#3b82f6] mb-3">4. Kiểm soát rủi ro và chi phí</h4>
                        <ul class="list-disc list-inside text-gray-700 text-sm">
                            <li>Nhận diện sớm sản phẩm lỗi thời, hư hỏng, từ đó thanh lý hoặc điều chỉnh sản xuất kịp thời.</li>
                            <li>Giảm chi phí lưu kho, bảo quản, bảo hiểm hàng hóa.</li>
                        </ul>
                    </div>
                    <div class="card md:col-span-2">
                        <h4 class="font-bold text-xl text-[#3b82f6] mb-3">5. Cải thiện dự báo và lập kế hoạch sản xuất</h4>
                        <ul class="list-disc list-inside text-gray-700 text-sm">
                            <li>Phân tích vòng quay theo thời gian/sản phẩm giúp cải thiện độ chính xác dự báo nhu cầu.</li>
                            <li>Lập kế hoạch sản xuất và mua hàng hiệu quả hơn, tránh thừa/thiếu hàng.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="dio" class="mb-16">
            <h2 class="section-title">V. Số Ngày Tồn Kho Bình Quân (Days Inventory Outstanding - DIO)</h2>
            <div class="card text-center max-w-2xl mx-auto">
                <p class="mb-4 text-gray-700">
                    Ngoài vòng quay hàng hóa, một chỉ số liên quan và cũng rất hữu ích là <strong>Số Ngày Tồn Kho Bình Quân (DIO)</strong>, cho biết trung bình mất bao nhiêu ngày để công ty bán hết hàng tồn kho của mình.
                </p>
                <div class="formula-box">
                    <span class="formula-text">DIO = Số ngày chu kỳ kế toán / Vòng Quay Hàng Hóa</span>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    Chỉ số này giúp nhà quản lý dễ hình dung hơn về thời gian hàng hóa nằm trong kho, từ đó đưa ra các quyết định tối ưu hóa.
                </p>
            </div>
        </section>

        <section id="gemini-calculator" class="mb-16">
            <h2 class="section-title">✨ Công cụ tính toán và phân tích</h2>
            <div class="calculator-card mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <p class="text-gray-700 flex-grow pr-4">
                        Sử dụng công cụ này để tính toán nhanh Vòng Quay Hàng Hàng Hóa (Inventory Turnover) và Số Ngày Tồn Kho Bình Quân (DIO). Nhập các số liệu của bạn dưới đây, và AI sẽ giúp bạn đưa ra một phân tích tổng quan!
                    </p>
                    <button id="show-history-button" class="history-button">Lịch sử</button>
                </div>
                
                <!-- Updated layout for inputs -->
                <div class="flex flex-col md:flex-row flex-wrap gap-6 mb-6">
                    <div class="calculator-input-group flex-1">
                        <label for="cogs">Giá vốn hàng bán (VNĐ)</label>
                        <input type="text" id="cogs" placeholder="VD: 15.000.000.000">
                    </div>
                    <div class="calculator-input-group flex-1">
                        <label for="start-inventory">Hàng tồn kho đầu kỳ (VNĐ)</label>
                        <input type="text" id="start-inventory" placeholder="VD: 2.500.000.000">
                    </div>
                    <div class="calculator-input-group flex-1">
                        <label for="end-inventory">Hàng tồn kho cuối kỳ (VNĐ)</label>
                        <input type="text" id="end-inventory" placeholder="VD: 3.500.000.000">
                    </div>
                </div>
                <div class="w-full mb-6">
                    <div class="calculator-input-group">
                        <label for="accounting-period">Số ngày chu kỳ kế toán</label>
                        <input type="number" id="accounting-period" value="365" min="1">
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row items-center justify-between mt-4 space-y-4 md:space-y-0 md:space-x-4">
                    <button id="calculate-button" class="calculator-button">
                        Tính toán & Phân tích ✨
                    </button>
                </div>
                <div id="loading-indicator" class="mt-4">
                    Đang tính toán và phân tích... Vui lòng chờ trong giây lát.
                </div>
                <div id="result-display">
                    <h3>Kết quả của bạn</h3>
                    <div class="flex items-center space-x-4 mt-4">
                        <div class="flex-1">
                            <p><strong>Vòng Quay Hàng Hóa:</strong> <span id="turnover-value"></span></p>
                            <p><strong>Số Ngày Tồn Kho Bình Quân (DIO):</strong> <span id="dio-value"></span></p>
                        </div>
                        <div class="flex items-center">
                            <button id="save-button" class="flex-shrink-0">Lưu lại</button>
                            <span id="save-status"></span>
                        </div>
                    </div>
                    <div id="comparison-analysis"></div>
                    <div id="analysis-text" class="text-sm">
                        <h4 class="font-bold text-lg text-[#1a56db] mt-4 mb-2">Phân tích tổng quan</h4>
                        <div id="overall-analysis"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="history-section">
            <h2 class="section-title">Lịch sử phân tích</h2>
            <div id="history-content">
                <!-- History items will be dynamically inserted here -->
            </div>
            <div id="history-loading-indicator" class="text-center italic text-gray-500 mt-4">Đang tải lịch sử...</div>
            <div id="no-history-message" class="text-center italic text-gray-500 mt-4">Chưa có bản phân tích nào được lưu.</div>
        </section>

    </main>

    <footer class="bg-gray-100 py-8 text-center text-gray-600">
        <div class="container mx-auto px-6">
            <p><strong>Người đề xuất:</strong> Nguyễn Đức Tâm - Trưởng phòng kinh doanh iFan</p>
            <p>&copy; 2025 Công ty TNHH Công nghiệp Nghệ Năng. Mọi quyền được bảo lưu.</p>
        </div>
    </footer>
    <script type="module">
        // --- KHÔNG SỬ DỤNG FIREBASE, CHUYỂN SANG LOCAL STORAGE ---
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization (Removed)
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // const app = initializeApp(firebaseConfig);
        // const db = getFirestore(app);
        // const auth = getAuth(app);
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userId = 'local-user'; // Dùng một ID cố định cho local storage
        let isAuthReady = true; // Luôn sẵn sàng vì không cần xác thực Firebase

        // UI Elements
        const calculateButton = document.getElementById('calculate-button');
        const saveButton = document.getElementById('save-button');
        const showHistoryButton = document.getElementById('show-history-button');
        const cogsInput = document.getElementById('cogs');
        const startInventoryInput = document.getElementById('start-inventory');
        const endInventoryInput = document.getElementById('end-inventory');
        const accountingPeriodInput = document.getElementById('accounting-period');
        const resultDisplay = document.getElementById('result-display');
        const turnoverValueSpan = document.getElementById('turnover-value');
        const dioValueSpan = document.getElementById('dio-value');
        const overallAnalysisDiv = document.getElementById('overall-analysis');
        const comparisonAnalysisDiv = document.getElementById('comparison-analysis');
        const loadingIndicator = document.getElementById('loading-indicator');
        const saveStatusSpan = document.getElementById('save-status');
        const historySection = document.getElementById('history-section');
        const historyContentDiv = document.getElementById('history-content');
        const historyLoadingIndicator = document.getElementById('history-loading-indicator');
        const noHistoryMessage = document.getElementById('no-history-message');

        // State variables to hold calculated data
        let currentResult = null;
        let currentAnalysis = null;
        let latestHistory = [];

        // Function to format number with thousands separator
        function formatNumber(input) {
            const value = input.value.replace(/\./g, '');
            if (value === '' || isNaN(value)) {
                input.value = '';
                return;
            }
            input.value = new Intl.NumberFormat('vi-VN').format(value);
        }

        // Add event listeners for number formatting
        cogsInput.addEventListener('input', (e) => formatNumber(e.target));
        startInventoryInput.addEventListener('input', (e) => formatNumber(e.target));
        endInventoryInput.addEventListener('input', (e) => formatNumber(e.target));

        // Hàm xử lý định dạng Markdown thành HTML
        function formatMarkdownToHtml(markdownText) {
            let html = markdownText.trim();
            
            // Xử lý in đậm (strong)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Xử lý gạch đầu dòng (bullet points)
            const lines = html.split('\n');
            let formattedLines = [];
            let inList = false;

            lines.forEach(line => {
                // Kiểm tra nếu dòng bắt đầu bằng * hoặc -
                if (line.trim().startsWith('* ') || line.trim().startsWith('- ')) {
                    if (!inList) {
                        formattedLines.push('<ul>');
                        inList = true;
                    }
                    // Bỏ ký tự gạch đầu dòng và thêm vào thẻ li
                    formattedLines.push(`<li>${line.trim().substring(2)}</li>`);
                } else {
                    if (inList) {
                        formattedLines.push('</ul>');
                        inList = false;
                    }
                    if (line.trim() !== '') {
                        formattedLines.push(`<p>${line.trim()}</p>`);
                    }
                }
            });

            if (inList) {
                formattedLines.push('</ul>');
            }

            return formattedLines.join('');
        }
        
        // Main function to calculate and call API
        async function calculateAndAnalyze() {
            // Display loading state
            resultDisplay.style.display = 'none';
            loadingIndicator.style.display = 'block';
            calculateButton.disabled = true;
            saveButton.style.display = 'none';
            saveStatusSpan.style.display = 'none';
            overallAnalysisDiv.innerHTML = '';
            comparisonAnalysisDiv.innerHTML = '';
            currentResult = null;
            currentAnalysis = null;

            try {
                // Get values and parse
                const cogs = parseFloat(cogsInput.value.replace(/\./g, ''));
                const startInventory = parseFloat(startInventoryInput.value.replace(/\./g, ''));
                const endInventory = parseFloat(endInventoryInput.value.replace(/\./g, ''));
                const accountingPeriod = parseInt(accountingPeriodInput.value, 10);

                // Input validation
                if (isNaN(cogs) || isNaN(startInventory) || isNaN(endInventory) || isNaN(accountingPeriod) || cogs < 0 || startInventory < 0 || endInventory < 0 || accountingPeriod <= 0) {
                    overallAnalysisDiv.innerHTML = '<p class="text-red-500">Vui lòng nhập các số liệu hợp lệ và số ngày chu kỳ kế toán phải lớn hơn 0.</p>';
                    resultDisplay.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    calculateButton.disabled = false;
                    return;
                }
                
                // Avoid division by zero
                const averageInventory = (startInventory + endInventory) / 2;
                if (averageInventory === 0) {
                    overallAnalysisDiv.innerHTML = '<p class="text-red-500">Hàng tồn kho bình quân không thể bằng 0. Vui lòng nhập số liệu khác.</p>';
                    resultDisplay.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    calculateButton.disabled = false;
                    return;
                }

                // Calculate metrics
                const inventoryTurnover = cogs / averageInventory;
                const dio = accountingPeriod / inventoryTurnover;
                
                // Update UI with results
                turnoverValueSpan.textContent = `${inventoryTurnover.toFixed(2)} lần`;
                dioValueSpan.textContent = `${dio.toFixed(2)} ngày`;
                
                // Store results temporarily for saving
                currentResult = { cogs, startInventory, endInventory, accountingPeriod, turnover: inventoryTurnover, dio: dio };

                let prompt = `Bạn là một chuyên gia phân tích tài chính. Dựa trên các chỉ số sau đây của Công ty TNHH Công nghiệp Nghệ Năng (một công ty hoạt động trong lĩnh vực sản xuất và kinh doanh thiết bị điện, điện tử dân dụng, công nghiệp; sản phẩm quạt điện cao cấp) bạn hãy phân tích ngắn gọn, tập trung và đưa ra các gợi ý hành động.
                
                Chỉ số tài chính:
                - Vòng quay hàng hóa: ${inventoryTurnover.toFixed(2)} lần
                - Số ngày tồn kho bình quân: ${dio.toFixed(2)} ngày
                - Chu kỳ kế toán: ${accountingPeriod} ngày
                
                Nội dung phân tích cần phải:
                - Chỉ tập trung vào phân tích ý nghĩa của các chỉ số trên.
                - Đưa ra góc nhìn tổng quan về hiệu quả quản lý tồn kho của Nghệ Năng.
                - Gợi ý các hành động cụ thể, thiết thực cho Công ty Nghệ Năng.
                - Sử dụng định dạng gạch đầu dòng (bullet points) để dễ đọc.
                - Không nhắc lại các thông tin về ngành nghề của công ty hay giải thích lại công thức tính.`;
                
                // Comparison with history
                // Lấy lịch sử từ localStorage để so sánh
                const storedHistory = JSON.parse(localStorage.getItem('inventoryAnalysisHistory') || '[]');
                if (storedHistory.length > 0) {
                    // Sắp xếp để lấy bản phân tích gần nhất
                    storedHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const previousAnalysis = storedHistory[0];
                    const prevTurnover = previousAnalysis.turnover;
                    const prevDio = previousAnalysis.dio;
                    const prevDate = new Date(previousAnalysis.timestamp).toLocaleDateString('vi-VN');
                    
                    const turnoverChange = inventoryTurnover - prevTurnover;
                    const dioChange = prevDio - dio; // DIO decrease is an improvement

                    let comparisonPrompt = `
                    Dựa trên dữ liệu lịch sử, đây là sự so sánh với lần phân tích gần nhất (${prevDate}):
                    - Vòng quay hàng hóa: Thay đổi ${turnoverChange.toFixed(2)} lần (${turnoverChange > 0 ? 'Tăng' : 'Giảm'})
                    - Số ngày tồn kho: Thay đổi ${dioChange.toFixed(2)} ngày (${dioChange > 0 ? 'Giảm' : 'Tăng'})

                    Hãy đánh giá hiệu quả hoạt động dựa trên sự thay đổi này và đưa ra lời khuyên.
                    `;

                    prompt += comparisonPrompt;

                    // Display the comparison summary
                    let comparisonHtml = '';
                    let comparisonClass = 'comparison-analysis';
                    if (turnoverChange > 0 || dioChange > 0) {
                        comparisonHtml = `<h4 class="text-green-800 font-bold">Cải thiện hiệu quả hoạt động:</h4>
                            <p><strong>Vòng quay hàng hóa:</strong> tăng từ ${prevTurnover.toFixed(2)} lên ${inventoryTurnover.toFixed(2)} lần.</p>
                            <p><strong>Số ngày tồn kho:</strong> giảm từ ${prevDio.toFixed(2)} xuống ${dio.toFixed(2)} ngày.</p>
                            <p>Điều này cho thấy khả năng luân chuyển hàng tồn kho đang tốt hơn.</p>`;
                        comparisonClass = 'comparison-analysis'; // Green for improvement
                    } else if (turnoverChange < 0 || dioChange < 0) {
                        comparisonHtml = `<h4 class="text-red-800 font-bold">Hiệu quả hoạt động giảm sút:</h4>
                            <p><strong>Vòng quay hàng hóa:</strong> giảm từ ${prevTurnover.toFixed(2)} xuống ${inventoryTurnover.toFixed(2)} lần.</p>
                            <p><strong>Số ngày tồn kho:</strong> tăng từ ${prevDio.toFixed(2)} lên ${dio.toFixed(2)} ngày.</p>
                            <p>Cần xem xét lại các chiến lược để cải thiện.</p>`;
                        comparisonClass = 'comparison-analysis decline'; // Red for decline
                    } else {
                        comparisonHtml = `<h4 class="text-gray-800 font-bold">Hiệu quả hoạt động không thay đổi:</h4>
                            <p>Các chỉ số gần như không thay đổi so với lần phân tích gần nhất.</p>`;
                        comparisonClass = 'comparison-analysis';
                    }
                    
                    // Create a clear title for the comparison section
                    const comparisonTitle = `<h4 class="font-bold text-lg text-[#1a56db] mt-4 mb-2">So sánh với lịch sử (ngày ${prevDate})</h4>`;
                    comparisonAnalysisDiv.className = comparisonClass;
                    comparisonAnalysisDiv.innerHTML = comparisonTitle + comparisonHtml;
                }
                
                // Prepare and call API
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // KHÓA API ĐƯỢC ĐẶT TRỰC TIẾP TẠI ĐÂY.
                // CẢNH BÁO: KHÔNG NÊN LÀM ĐIỀU NÀY TRONG MÔI TRƯỜNG SẢN PHẨM CÔNG KHAI!
                const apiKey = "AIzaSyC6-hOHavm6hd8Y4u4gK6G2KG9Ev9SPQjs"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                // Implement exponential backoff for API calls
                const maxRetries = 5;
                let retryCount = 0;
                let response;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success, exit loop
                        } else if (response.status === 429) { // Too Many Requests
                            const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                        } else {
                            // Other errors, re-throw to be caught by outer try-catch
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    } catch (fetchError) {
                        console.error('Fetch error:', fetchError);
                        // If it's not a 429, or max retries reached, re-throw
                        if (retryCount === maxRetries - 1 || response?.status !== 429) {
                            throw fetchError;
                        }
                        retryCount++;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("Failed to get a successful response after retries.");
                }

                const result = await response.json();
                
                // Extract and display API response
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    currentAnalysis = text;
                    const formattedHtml = formatMarkdownToHtml(text);
                    overallAnalysisDiv.innerHTML = formattedHtml;

                } else {
                    overallAnalysisDiv.innerHTML = '<p class="text-red-500">Xin lỗi, đã xảy ra lỗi trong quá trình phân tích. Vui lòng thử lại sau.</p>';
                }
            } catch (error) {
                console.error('Lỗi khi gọi API hoặc tính toán:', error);
                overallAnalysisDiv.innerHTML = '<p class="text-red-500">Đã xảy ra lỗi nghiêm trọng. Vui lòng kiểm tra lại dữ liệu và thử lại.</p>';
            } finally {
                // Hide loading and show result
                loadingIndicator.style.display = 'none';
                resultDisplay.style.display = 'block';
                calculateButton.disabled = false;
                if (currentResult && currentAnalysis) {
                    saveButton.style.display = 'inline-block';
                }
            }
        }
        
        // Function to save the current analysis to localStorage
        async function saveAnalysis() {
            if (!currentResult || !currentAnalysis) {
                console.error("Không có dữ liệu để lưu.");
                return;
            }
            saveButton.disabled = true;
            saveStatusSpan.textContent = 'Đang lưu...';
            saveStatusSpan.style.display = 'inline';

            try {
                let history = JSON.parse(localStorage.getItem('inventoryAnalysisHistory') || '[]');
                const newItem = {
                    cogs: currentResult.cogs,
                    startInventory: currentResult.startInventory,
                    endInventory: currentResult.endInventory,
                    accountingPeriod: currentResult.accountingPeriod,
                    turnover: currentResult.turnover,
                    dio: currentResult.dio,
                    analysis: currentAnalysis,
                    timestamp: new Date().toISOString() // Lưu dưới dạng ISO string để dễ dàng parse lại
                };
                history.push(newItem);
                localStorage.setItem('inventoryAnalysisHistory', JSON.stringify(history));

                saveStatusSpan.textContent = 'Đã lưu thành công!';
                // Cập nhật lịch sử hiển thị ngay lập tức sau khi lưu
                fetchHistory(); 
                setTimeout(() => {
                    saveStatusSpan.style.display = 'none';
                    saveButton.disabled = false;
                }, 3000);
            } catch (e) {
                console.error("Lỗi khi lưu dữ liệu: ", e);
                saveStatusSpan.textContent = 'Lỗi khi lưu!';
                saveStatusSpan.style.color = '#ef4444';
                saveButton.disabled = false;
            }
        }
        
        // Function to fetch and display history from localStorage
        function fetchHistory() {
            historyContentDiv.innerHTML = '';
            historyLoadingIndicator.style.display = 'block';
            noHistoryMessage.style.display = 'none';

            try {
                const storedHistory = JSON.parse(localStorage.getItem('inventoryAnalysisHistory') || '[]');
                
                // Sort in memory to get latest item and for display
                // Chuyển đổi timestamp từ ISO string sang Date object để sắp xếp
                storedHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                latestHistory = storedHistory; // Update global state
                
                historyContentDiv.innerHTML = '';
                if (storedHistory.length === 0) {
                    noHistoryMessage.style.display = 'block';
                } else {
                    noHistoryMessage.style.display = 'none';
                    storedHistory.forEach(item => {
                        const date = new Date(item.timestamp).toLocaleString('vi-VN'); // Chuyển đổi lại Date object để hiển thị
                        const itemHtml = `
                            <div class="history-item">
                                <details>
                                    <summary>Phân tích ngày ${date}</summary>
                                    <div class="history-details-content">
                                        <p><strong>Giá vốn:</strong> ${new Intl.NumberFormat('vi-VN').format(item.cogs)} VNĐ</p>
                                        <p><strong>Tồn kho đầu kỳ:</strong> ${new Intl.NumberFormat('vi-VN').format(item.startInventory)} VNĐ</p>
                                        <p><strong>Tồn kho cuối kỳ:</strong> ${new Intl.NumberFormat('vi-VN').format(item.endInventory)} VNĐ</p>
                                        <p><strong>Chu kỳ kế toán:</strong> ${item.accountingPeriod} ngày</p>
                                        <p><strong>Vòng quay:</strong> ${item.turnover.toFixed(2)} lần</p>
                                        <p><strong>Số ngày tồn kho:</strong> ${item.dio.toFixed(2)} ngày</p>
                                        <div class="mt-4 text-sm text-gray-700">${formatMarkdownToHtml(item.analysis)}</div>
                                    </div>
                                </details>
                            </div>
                        `;
                        historyContentDiv.innerHTML += itemHtml;
                    });
                }
            } catch (e) {
                console.error("Lỗi khi tải lịch sử từ localStorage: ", e);
                historyContentDiv.innerHTML = '<p class="text-red-500">Lỗi khi tải lịch sử.</p>';
            } finally {
                historyLoadingIndicator.style.display = 'none';
            }
        }
        
        // Toggle history section visibility
        function toggleHistory() {
            if (historySection.style.display === 'block') {
                historySection.style.display = 'none';
            } else {
                historySection.style.display = 'block';
                fetchHistory(); // Tải lịch sử mỗi khi mở
            }
        }

        // Event listeners
        calculateButton.addEventListener('click', calculateAndAnalyze);
        saveButton.addEventListener('click', saveAnalysis);
        showHistoryButton.addEventListener('click', toggleHistory);
        
        // Initial load of history
        window.onload = function() {
            fetchHistory();
        };
    </script>
</body>
</html>
